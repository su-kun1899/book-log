# プロフェッショナルIPv6

## 序文

- IPv4は数に制約があった
- IPv6自体は昔からあった
- 2011年に在庫が枯渇したことにより普及が加速する
  - Appleがアプリの審査基準に入れたことも大きい

### 混ざりつつも、似て非なるプロトコル

- IPv6の特徴は128ビットで表現されること
  - IPv4は32ビットなので2の96乗倍
- 似ている部分もあるが、直接の互換性はない
- 違うものなのに並行運用されるのでややこしくなる

## 第Ⅰ部 本書を読むにあたっての前提知識

### 第1章 インターネット概要

- IPv6はインターネットプロトコルのバージョン6
- IPv6はIPv4のアドレス在庫枯渇が背景にある
  - IPv4は2の32乗(約43億)
- CIDRやNATはアドレス枯渇を遅らせる方法として考案された

#### 🤔 CIDR

- IPアドレスにはネットワーク部とホスト部がある
- IPv4だとIPアドレスは4つのオクテットで表現される(XXX.XXX.XXX.XXX)
  - 1オクテットは8ビット（2進数8桁）
- グローバルIPだとネットワーク規模でネットワーク部を決めていた
  - ネットワーク部の表現をネットマスクと呼ぶ
  - クラスは最初の数字で判別する
    - 「0XXXXXXX」ならクラスA
    - 「10XXXXXX」ならクラスB
    - 「110XXXXX」ならクラスC
  - クラスAだと第1オクテットがネットワーク部、ホストは2の24乗？
    - 255.0.0.0がネットマスク（/255.0.0.0もしくは/8）
- CIDRはアドレス部を自由に決める方法
  - ネットワーク部分を表現するにはサブネットを使う（192.168.0.5/255.255.255.0）
    - サブネットマスク
  - ビット数で表現してもよい（192.168.0.5/24）
  - 2進数の24桁分がネットワーク部ということ
- [サブネットマスクの計算をマスターする](http://www.atmarkit.co.jp/ait/articles/0805/15/news134.html)
- [アドレス・クラスとさまざまなIPアドレス](http://www.atmarkit.co.jp/ait/articles/0301/17/news003.html)

#### 🤔 NAT

- Network Address Translation
- 内部ネットワークからインターネットに出る際にプライベートIPをグローバルIPに変換する

### 1.1 IPはパケット交換技術

- インターネットはパケット単位で通信する
- パケットはデータを小分けにする
- 複数の通信を一つの回線で行えるので効率が良い

### 1.1.1 IPパケットのフォーマット

- ヘッダとペイロードがある
- ペイロードが送るデータ
- 実際はバイト列
- バイト列の並べ方をバイトオーダー、並べ方の種類をエンディアンと呼ぶ
- ビッグエンディアンとリトルエンディアン
  - 大きい順と小さい順
- TCP/IPでは事実上ビッグエンディアンに統一されている
  - ネットワークバイトオーダーと呼ぶ(コンピュータ内でのエンディアンはホストバイトオーダー)

### 1.1.2 IPパケットを転送するルータ

- パケットの経路を提供する
- IPパケットを次のルータに送るだけ
  - ルーティングテーブルで次の送り先を決める

### 1.1.3 ルータ、ホスト、ノード

- ノード（node）: 節点を表すもの
  - ルータもパケットを転送するノード
  - RFCでは「IPv6を実装した機器」
- ホスト
  - ネットワークの文脈では末端に接続されたノード
  - パケットを転送する機能を持たない
  - RFCでは「ルータではないノード」
  - 「エンドノード」とも呼ばれる

### 1.1.4 IPアドレスの構成

- ルーティングテーブルにはIPアドレスの範囲を集約したものが格納されている
  - サブネット、あるいは単にネットワークと呼ぶ
  - 前半が共通であれば同じネットワーク
- IPv4では前半をネットワーク部、後半をホスト部と呼ぶ
- IPv6では前半をネットワーク識別子、後半をインターフェース識別子と呼ぶ
  - IPv6では前半64ビットがネットワーク識別子、後半64ビットがインターフェース識別子
- あるデータから特定の情報を取り出す時にマスク（ビットマスク）を使う
  - IPアドレスからネットワーク部分を取り出すのがネットマスク
  - ビット列からネットワークを示す部分をすべて1にしたのがネットマスク（255.255.0.0？）
- IPv6では16進数で表現する
  - `2001:db8::1` というアドレス（::は0連続の省略）
  - ネットマスクが `ffff:ffff:ffff:ffff::` の場合、ネットワーク識別子は `2001:db8::` になる
      - 16進数 `f` は2進数 `1111` になるので、先頭64ビットがすべて1

### 1.1.5 プレフィックス長

- ネットワークをIPアドレスの後ろに「/」で表現する形式
  - `2001:db8::/32` だと最初の32ビットがネットワークプレフィックスであるということ
- 💡 区切りはhextetっと呼ぶっぽい
- 🤔　db8は0db8ってことのようだ
- `2001:db8:ffff::1`
  - プレフィックス長が32: `2001:db8::/32`
  - プレフィックス長が33: `2001:db8:8000::/33`
  - プレフィックス長が34: `2001:db8:c000::/34`

### 1.1.6 ルーティングテーブルはどのように生成されているのか

- ルーターがパケットを転送する行為は「フォワーディング」と呼ぶ
- ルーティングテーブルの生成方法は２つに大別できる
  - 人間が手動で設定する静的な方法
  - ルーター同士が協調して生成する動的な方法
    - ルーティングプロトコル
- インターフェースがひとつならデフォルトルータを設定すればよい
  - 家庭内のネットワーク-デフォルトルータ(デフォルトゲートウェイ)-インターネット
- 動的な生成にはルーティングプロトコルを使う
  - 伝言ゲームのように隣にある器機を伝えていくディスタンスベクタ型という方式
    - RIP: IPv4でしか使えない古いプロトコル
    - RIPng: 昔使われていたIPv6向けのRIP拡張
  - 周囲にある機器の一覧をルータと共有するリンクステート型という方式
    - OSPF
      - IPv4はOSPFv2
      - IPv6はOSPFv3
        - OSPFv3はIPv4とIPv6の両方を扱えるようになった
    - IS-IS
    - 機器の一覧を共有する必要があるので、インターネット全体のような大規模ネットワークには向かない
- ネットワークのネットワークでルーティングを行う仕組み
  - AS(自律システム)
    - 各組織が責任を持ってルーティングを行うネットワーク
  - BGP
    - AS単位で経路制御を行うルーティングプロトコル
    - IPv4はBGP4
    - IPv6でも使えるようにしたのがBGP4+

#### 1.2 層に分かれるネットワーク

- インターネットは4つの階層に分けられる
  - アプリケーション層
  - トランスポート層
  - ネットワーク層
  - リンク層
- リンク層
  - 隣の機器との接続性を扱う
  - 通信方法
- ネットワーク層
  - 隣より離れた機器との通信方法
  - IPv4とIPv6はネットワーク層のプロトコル
- ルータを越えないのがリンク層、越えるのがネットワーク層
- 階層構造のメリット
  - 階層がないと、お互いのネットワークに関わるすべての情報を把握する必要がある
  - IPv4とIPv6が同じ回線で動作できるのも階層設計の恩恵
- トランスポート層
  - IPv4やIPv6で決められているのはIPパケットを届ける仕事まで
  - IPパケットをどのように届けるか、どう扱うかという仕事がトランスポート層
  - TCPやUDPが代表的なプロトコル

#### 1.2.1 階層構造とパケット

- イーサネットはリンク層のプロトコル
- イーサネットフレーム(リンク層)
  - イーサネットヘッダの次にIPパケット(ネットワーク層)
  - 階層ごとにヘッダがあり、次の階層のプロトコルのヘッダが続く
  - イーサネットヘッダ - IPv6ヘッダ - TCPヘッダ - HTTPヘッダ - Webコンテンツ
- Next Header
  - IPv6パケットがペイロードのデータの先頭が何であるかを示す
    - TCPだと「6」
    - IPv4だとProtocolフィールドが「6」になる

#### 1.2.2 イーサネットにおける違い

- イーサネットだとリンク層でIPv4とIPv6を区別できる
- イーサネットヘッダのタイプフィールドで決まる
  - RFC2464
- マルチキャストで利用されるアドレスも異なる

#### 1.3 トランスポート層の役割

- インターネットは「パケットが届くかどうかをネットワークそのものでは保証しない」仕組み
  - ルーターは個別の通信には関与しない
  - 通信の状況は末端の機器で把握する
- パケットの到達性などはトランスポート層で保証する
  - TCPが代表的なプロトコル
- バーチャルサーキット
  - IPパケットはルーターを転送されていくだけで通信の双方が接続されるわけではない
  - TCPのような仮想的な接続をバーチャルサーキットと呼ぶ
- TCP
  - データの到達性を保証する
  - パケットが届かないと再送要求
  - 受信完了パケットのやり取り
    - ACK(アック)
  - パケットを送信順に受け取る仕組みもある
- TCPのおかげでパケットを意識せずにアプリケーションプログラムを書ける
  - TCPがなければインターネットはここまで普及しなかったかもしれない
- 分散処理
  - 到達性等を末端の機器でがんばる
  - 各機器が自分たちの通信のみ把握すればよい
- UDP
  - TCPでは都合の悪い通信、TCPほどの機能が不要な通信で使う
    - リアルタイム性の要求（音声や動画）
    - 同時に多数の相手と通信（マルチキャストやブロードキャスト）
  - アプリケーションプログラマが必要な機能を自作するカスタム設定用のプロトコルともいえる
- SCTPやQUICというUDPを使った新たなトランスポートプロトコルもある
